---
title: "Prospective analysis with delay"
---

```{r}
source("ranScanInit2.r")
case.file = "Data/Full MOLIS dataset minus PII 20200918.xlsx"
case.df = ranScanInit(case.file)
```



```{r}
emmtype='44.0' ##44.0 #1.0 #33.0
n.weeks = 150
starting.week = 80
ranScanCreateObservationMatrices_(case.file, emmtype, starting.week = starting.week, n.weeks = n.weeks)
```


```{r}
load(sprintf("Data/%s_typed_obs.Rdata", emmtype), verbose = 1)
load('Data/untyped_obs.Rdata', verbose = 1)

print(head(names(observation.matrices.untyped)))
observation.matrices.untyped[['150']][1:5,1:5]
observation.matrices.untyped[[10]] %>% rownames %>% head
observation.matrices.typed[[emmtype]][['150']][1:5,1:5]
```


```{r}
init=Sys.time()
postcode2coord = ranScanPostcodeMap(observation.matrices.untyped[[1]])
print(Sys.time()-init)
```

```{r}
time.factor = ranScanTimeFactor(case.file)
```

```{r}
baseline.matrix = ranScanCreateBaselineMatrix(case.file)
```

```{r}
emmtype.factor = ranScanEmmtypeFactor.tau(case.file, emmtype)
delay.factor = ranScanEmmtypeFactor.delay_(case.file, starting.week = starting.week, n.weeks = n.weeks)
```

```{r}
for (t in as.character(seq(150,290, 15))){
  cols = colnames(observation.matrices.untyped[[t]])
  emt.factor = emmtype.factor[[emmtype]][cols]
  dly.factor = delay.factor
  
  bsl.matrix.typed = baseline.matrix[,cols] * rep((1 - dly.factor) * emt.factor,
                                                      rep(NROW(baseline.matrix[,cols]),
                                                          NCOL(baseline.matrix[,cols])))
  
  bsl.matrix.untyped = baseline.matrix[,cols] * rep(dly.factor,
                                                      rep(NROW(baseline.matrix[,cols]),
                                                          NCOL(baseline.matrix[,cols])))
  x = as.integer(colnames(observation.matrices.typed[[emmtype]][[t]]))
  y = colSums(observation.matrices.typed[[emmtype]][[t]])
  y1 = colSums(observation.matrices.untyped[[t]])
  plot(range(x), c(0, max(c(y,y1))), xlab = bquote(tau~'[week]'), ylab='no. cases per week', col=NA,
       main=sprintf('screenshot at week %s', t))
  y = ifelse(y > 0, y, NA)
  y1 = ifelse(y1 > 0, y1, NA)
  points(x, y, col='red', pch=20)
  points(x, y1)
  idx = !(rownames(bsl.matrix.typed) == 'NA')
  lines(x, colSums(bsl.matrix.typed[idx,]), col='red')
  lines(x, colSums(bsl.matrix.untyped[idx,]))
  legend('topleft', legend=c(sprintf('emm %s observations', emmtype), 'untyped observations', sprintf('emm %s baseline',emmtype), 'untyped baseline'), pch=c(20, 1, NA, NA), col=c('red','black','red','black'), lty = c(NA,NA,1,1))
  
  cat(t, "total bsl", sum(bsl.matrix.typed[-2,]) + sum(bsl.matrix.untyped[-2,]), '\n')
  cat(t, "total observed cases", sum(y, na.rm = T) + sum( y1, na.rm = T), '\n')
}
```

# model for delay
```{r}
L=len(dly.factor)
y = dly.factor[(L-10):L]
geo<-function(r){r**(10:0)}
rmsd = function(x,y){  return( sqrt( mean((x-y)**2))) }
rest = optimize(function(x){  rmsd(geo(x), y)}, c(0, 1) )$minimum
plot(-10:0, y, ylab = 'Fraction of untyped cases', xlab = 'time elapsed from detection date [week]', xaxt='n', col='#1f77b4', xlim = c(-6,0))
axis(1, at = -10:0, labels=-(-10:0))
#lines(10:0, geo(rest))
leng=100
rest_ = vector(mode = "numeric", length = leng)
for (i in 1:leng){
   idx = sample(1:11, replace = T)
   rest_[i] = optimize(function(x){  rmsd(  geo(x)[idx],  y[idx])}, c(0, 1) )$minimum
}
#rest_ = quantile(rest_, c(0.025, 0.5,0.975))
rest_ = quantile(rest_, c(0.158, 0.5,0.6827+0.158))
print(rest_)
#lines(-10:0, geo(rest_[1]), col='#1f77b4')
points(-10:0, geo(rest_[2]), col='#ff7f0e', pch=19)
lines(-10:0, geo(rest_[2]), col='#ff7f0e', lty=2)
#lines(-10:0, geo(rest_[3]), col='red')
ylow=geo(rest_[1])
yupp=geo(rest_[3])
x = -10:0
for (i in 1:length(x)){
  segments(x0 =x[i], y0 = ylow[i], x1 = x[i], y1 = yupp[i], col='#ff7f0e' )
  print(c(x[i], yupp[i]))
}
points(-10:0, y, ylab = 'Fraction of untyped cases', xlab = 'time elapsed from detection date [week]', xaxt='n', col='#1f77b4', xlim = c(-6,0))
legend('topleft',legend = c('data', 'fit'), col = c('#1f77b4','#ff7f0e'), lty = c(NA, 2), pch=c(1,19))
```
```{r}
# tab:blue : #1f77b4
# tab:orange : #ff7f0e
# tab:green : #2ca02c
# tab:red : #d62728
# tab:purple : #9467bd
# tab:brown : #8c564b
# tab:pink : #e377c2
# tab:gray : #7f7f7f
# tab:olive : #bcbd22
# tab:cyan : #17becf
```

```{r include=FALSE}
source("ranScanEvaluate.r")
```

```{r include=FALSE}
sizefactor = 1.2
n_cyl = 50000
weeks = attributes(observation.matrices.untyped)$names
n.rows = sum(case.df$emmtype == emmtype)
n.cols = len(weeks)

to.export = as.data.frame(matrix(NA, nrow = n.rows, ncol = n.cols))
names(to.export) = mapply(function(x){paste0('week.', x)}, as.character(weeks))

dly.factor = delay.factor
  
for (week in weeks){
  # week.min = max(1, week - 200)
  # week.range = c(1, week)
  # cat('week', week, week.range, '\t')
  writeLines(week)
  obs.matrix.untyped = observation.matrices.untyped[[week]]
  obs.matrix.typed = observation.matrices.typed[[emmtype]][[week]]
#  obs.matrix = obs.matrix.untyped + obs.matrix.typed
  cols = colnames(obs.matrix.typed)
  emt.factor = emmtype.factor[[emmtype]][cols]

  # moltiplicazione columnwise
  bsl.matrix.typed = baseline.matrix[,cols] * rep( (1 - dly.factor)*emt.factor,
                                                     rep(NROW(baseline.matrix[,cols]), NCOL(baseline.matrix[,cols])))
  bsl.matrix.untyped = baseline.matrix[,cols] * rep( dly.factor,
                                                     rep(NROW(baseline.matrix[,cols]), NCOL(baseline.matrix[,cols]))) 
  #
#  bsl.matrix = bsl.matrix.typed + bsl.matrix.untyped
  week.range = range(as.integer(cols))
  #print(c(sum(obs.matrix[-2,]), sum(bsl.matrix[-2,])))
  # colnames(obs.matrix.typed) = colnames(bsl.matrix.typed)
  # colnames(obs.matrix.untyped) = colnames(bsl.matrix.typed)

  cylinders = ranScanCreateCylinders.delay(obs.matrix.typed, bsl.matrix.typed,
                                            obs.matrix.untyped, bsl.matrix.untyped, emmtype, week.range,
                                            n_cyl, postcode2coord, size_factor = sizefactor)
  
  case.df.tmp = ranScanEvaluate(case.file, cylinders, emmtype, p.val.threshold=0.05)
  ws = case.df.tmp[case.df.tmp$emmtype == emmtype,]$warning.score
  i = as.integer(week) - as.integer(weeks[1]) + 1
  to.export[, i] = ws
}

dataframe.to.export = cbind(case.df.tmp[case.df.tmp$emmtype == emmtype,], to.export)
dataframe.to.export$warning.score = NULL
#plot(weeks, unlist(dataframe.to.export[2,16:218]))
```

```{r}
plot(range(weeks), c(0,1), col='white', xlab = 'week', ylab='warning score')
L = NCOL(dataframe.to.export)
for (i in 1:2300){
  if( !is.na(dataframe.to.export[i,'x'])){
    lines(weeks, unlist(dataframe.to.export[i,16:L]))
  }
}
abline(h=0.95)

write.csv(dataframe.to.export, file = paste0('emmtype_', emmtype, '_with_delay2_sf1.2.csv'))
```


# comparison delay vs no-delay

```{r}
#emmtype_44_0_with_delay_sf1_2 <- read.csv("emmtype_44.0_with_delay_sf1.2.csv")
emmtype_44_0_sf1_2 <- read.csv("emmtype_44.0_sf1.2.csv")
rownames(emmtype_44_0_sf1_2) = emmtype_44_0_sf1_2$X
tmp = emmtype_44_0_sf1_2[dataframe.to.export$X,]
idx = which(tmp[, 219] > 0.8)

weeks = 150:293
for (i in 1:2300){
  if( !is.na(tmp[i,'x']) & i %in%  idx){
    title = sprintf("sampled %d - typed on %d", tmp[i,'SAMPLE_DT_numeric'], tmp[i,'RECEPT_DT_numeric'] )
    plot(c(150,293), c(0,1), col='white', xlab = 'week', ylab='warning score', main=title)
    lines(150:293, unlist(dataframe.to.export[i,16:159]), xlab = 'week', ylab='warning score')
    lines(96:298, unlist(tmp[i,17:219]), col='red')
    abline(h=0.95, col='grey')
  }
}

# weeks = 150:293
# plot(range(weeks), c(0,1), col='white', xlab = 'week', ylab='warning score')
# L = NCOL(emmtype_44_0_with_delay_sf1_2)
# for (i in 1:2300){
#   if( !is.na(dataframe.to.export[i,'x'])){
#     lines(weeks, unlist(emmtype_44_0_with_delay_sf1_2[i,17:L]))
#   }
# }
# lines(150:290, time.factor[150:290] / 40, col='red')
# abline(h=0.95)
```

