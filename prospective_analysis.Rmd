---
title: "Prospective analysis"
---

```{r warning=TRUE, include=FALSE}
source("ranScanInit2.r")
case.file = "Data/Full MOLIS dataset minus PII 20200918.xlsx"
case.df = ranScanInit(case.file)
```


```{r}
emmtype='44.0'
ranScanCreateObservationMatrices(case.file, emmtype)
load(paste0("~/Outbreak/Data/", emmtype, "_obs.Rdata"))
#time.factor = ranScanTimeFactor(case.file)
```

```{r}
baseline.matrix = ranScanCreateBaselineMatrix(case.file)
```


```{r}
init=Sys.time()
postcode2coord = ranScanPostcodeMap(observation.matrix)
print(Sys.time()-init)
```

```{r}
emmtype.factor = ranScanEmmtypeFactor.tau(case.file, emmtype)
```

```{r include=FALSE}
source("ranScanEvaluate.r")
```


```{r include=FALSE}
sizefactor = 1.2
n_cyl = 50000 # min(50000, sum(obs.matrix.typed[-13,]) * 10 )

# moltiplicazione columnwise
baseline.matrix.tmp = baseline.matrix * rep(c(0,0,emmtype.factor[[emmtype]]), rep(NROW(baseline.matrix), NCOL(baseline.matrix) ))
postcode2coord = ranScanPostcodeMap(observation.matrix)

weeks = 96:max(as.integer(colnames(observation.matrix)), na.rm = T)

n.rows = sum(case.df$emmtype == emmtype)
n.cols = len(weeks)
to.export = as.data.frame(matrix(NA, nrow = n.rows, ncol = n.cols))
names(to.export) = mapply(function(x){week2Date(x)}, as.character(weeks))
#
for (week in weeks){
  week.min = max(0, week - 200)
  week.range = as.character(week.min:week)
  cat('weeks:', range(as.integer(week.range)),'\t')
  
  cylinders = ranScanCreateCylinders(observation.matrix[,week.range], baseline.matrix.tmp[,week.range], emmtype, week.range, n_cyl, postcode2coord, size_factor = sizefactor)
  
  case.df.tmp = ranScanEvaluate(case.file, cylinders, emmtype, p.val.threshold=0.05)
  ws = case.df.tmp[case.df.tmp$emmtype == emmtype,]$warning.score
  i = week - weeks[1] + 1
  to.export[, i] = ws
}
```


```{r}
dataframe.to.export = cbind(case.df.tmp[case.df.tmp$emmtype == emmtype,], to.export)
dataframe.to.export$warning.score = NULL
write.csv(dataframe.to.export, file = paste0('emmtype_', emmtype, '__no_delay.csv'))
```

```{r}
dataframe.to.export = read.csv(paste0('emmtype_', emmtype, '__no_delay.csv'), row.names = 1, check.names = F)
plot.spaghetti(dataframe.to.export)
```





